<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Treemap Filler</title>
    <style>
      .inline-radio {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      padding: 2px 0;
      }

      .inline-radio input[type="radio"] {
      margin: 0;
      accent-color: #007AFF; /* optional: Figma-blue accent */
      transform: scale(1.1);
      }
      :root { color-scheme: light; }
      body { font: 12px/1.4 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 12px; color:#111; }
      h3 { margin: 0 0 8px; }
      label { display:block; margin: 8px 0 4px; }
      input, select, textarea, button { width: 100%; box-sizing: border-box; }
      textarea { resize: vertical; }
      .row { display:flex; gap:8px; }
      .row > div { flex:1; }
      fieldset { border:1px solid #ddd; padding:10px; border-radius:8px; margin-top:12px; }
      legend { padding:0 6px; color:#444; }
      .hint { color:#666; font-size:11px; }
      button { margin-top: 12px; padding: 8px; border-radius: 8px; }
    </style>
  </head>
  <body>
    <h3>Treemap options</h3>

    <label>Count (N)</label>
    <input id="count" type="number" min="1" max="500" value="25"/>

    <label>Padding (px)</label>
    <input id="padding" type="number" min="0" max="100" value="4"/>

    <label>Random seed <span class="hint">(blank = truly random)</span></label>
    <input id="seed" type="text" placeholder="e.g., 42"/>

    <label>Custom weights (optional)</label>
    <textarea id="weights" rows="4"
      placeholder="Comma or newline-separated numbers, e.g.:
12, 4, 9, 3, 7"></textarea>
    <div class="hint">If provided, N is ignored and the number of rectangles = number of weights.</div>

    <fieldset>
    <legend>Color mode</legend>

    <label class="inline-radio">
    Random palette (default)
    <input type="radio" name="colormode" value="random" checked>
    </label>

    <label class="inline-radio">
    Sample from linear gradient style
    <input type="radio" name="colormode" value="gradient">
    </label>

    <div id="gradient-controls" style="display:none; margin-top:6px;">
    <!-- existing gradient UI stays unchanged -->
    </div>
    </fieldset>

    <button id="run">Fill selected frame</button>

    <script>
      const $ = (id) => document.getElementById(id);

      // === Utility to request current styles from main thread ===
      function requestStyles() {
        parent.postMessage({ pluginMessage: { type: 'request-styles' } }, '*');
      }

      // === Color mode helpers ===
      function getColorMode() {
        const el = document.querySelector('input[name="colormode"]:checked');
        return el ? el.value : 'random';
      }

      // Show/hide gradient controls and re-fetch styles
      document.querySelectorAll('input[name="colormode"]').forEach(r => {
        r.addEventListener('change', () => {
          const isGradient = getColorMode() === 'gradient';
          $('gradient-controls').style.display = isGradient ? 'block' : 'none';
          if (isGradient) requestStyles();
        });
      });

      // === Receive messages from code.js ===
      window.onmessage = (e) => {
        const msg = e.data.pluginMessage;
        if (!msg) return;

        if (msg.type === 'styles') {
          const sel = $('gradientStyle');
          sel.innerHTML = '';
          if (!msg.styles.length) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = '(no linear gradient styles found)';
            sel.appendChild(opt);
          } else {
            msg.styles.forEach(s => {
              const opt = document.createElement('option');
              opt.value = s.id;
              opt.textContent = s.name;
              sel.appendChild(opt);
            });
          }
        }

        if (msg.type === 'style-created') {
          const sel = $('gradientStyle');
          const opt = document.createElement('option');
          opt.value = msg.style.id;
          opt.textContent = msg.style.name;
          sel.appendChild(opt);
          sel.value = msg.style.id;
        }

        if (msg.type === 'notify') {
          // Optional notifications
          // console.log(msg.message);
        }
      };

      // === Re-request styles when UI loads (and once more shortly after) ===
      window.addEventListener('DOMContentLoaded', () => {
        requestStyles();
        setTimeout(requestStyles, 100); // timing safety for UI mount
      });

      // === Create new gradient style ===
      $('createGradient').onclick = () => {
        const payload = {
          type: 'create-gradient-style',
          name: $('gName').value.trim() || 'Treemap Gradient',
          start: $('gStart').value.trim(),
          end: $('gEnd').value.trim(),
          angle: parseFloat($('gAngle').value) || 0
        };
        parent.postMessage({ pluginMessage: payload }, '*');
      };

      // === Run treemap ===
      $('run').onclick = () => {
        const count = parseInt($('count').value, 10);
        const padding = parseFloat($('padding').value);
        const seed = $('seed').value.trim();

        let weightsRaw = $('weights').value.trim();
        let weights = null;
        if (weightsRaw.length) {
          weights = weightsRaw
            .split(/[\s,]+/)
            .map(Number)
            .filter(n => Number.isFinite(n) && n > 0);
          if (!weights.length) weights = null;
        }

        const colorMode = getColorMode();
        const gradientStyleId = colorMode === 'gradient' ? $('gradientStyle').value : '';

        parent.postMessage({
          pluginMessage: { type: 'run', count, padding, seed, weights, colorMode, gradientStyleId }
        }, '*');
      };
    </script>
  </body>
</html>