<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>TreeMapper</title>
    <style>
      :root { color-scheme: light; }
      body {
        font: 12px/1.4 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        margin: 12px;
        color: #111;
      }
      h3 { margin: 0 0 8px; font-size: 13px; }
      label { display: block; margin: 6px 0 3px; }
      input, select, textarea, button { width: 100%; box-sizing: border-box; font-size: 12px; }
      textarea { resize: vertical; }
      fieldset { border: 1px solid #ddd; padding: 10px; border-radius: 8px; margin-top: 12px; }
      legend { padding: 0 6px; color: #444; font-weight: 500; }
      .hint { color: #666; font-size: 11px; }
      button { margin-top: 12px; padding: 8px; border-radius: 8px; }

      .row { display: flex; gap: 8px; }
      .row > div { flex: 1; }

      /* Inline radios: left-aligned, compact, with hover affordance */
      .inline-radio {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 4px 6px;
        border-radius: 6px;
        cursor: default;
        user-select: none;
      }
      .inline-radio:hover {
        background: rgba(0, 0, 0, 0.04);
      }
      @media (prefers-color-scheme: dark) {
        .inline-radio:hover { background: rgba(255, 255, 255, 0.06); }
      }
      .inline-radio input[type="radio"] {
        width: auto; /* don’t stretch */
        accent-color: #007AFF; /* optional Figma blue */
        margin: 0;
        transform: scale(1.05);
      }
      .inline-radio label {
        margin: 0; /* keep single-line, tight */
        width: auto;
        flex: 1 1 auto;
      }
    </style>
  </head>
  <body>
    <h3>Treemap options</h3>

    <label>Count (N)</label>
    <input id="count" type="number" min="1" max="500" value="25"/>

    <label>Padding (px)</label>
    <input id="padding" type="number" min="0" max="100" value="4"/>

    <label>Random seed <span class="hint">(blank = truly random)</span></label>
    <input id="seed" type="text" placeholder="e.g., 42"/>

    <label>Custom weights (optional)</label>
    <textarea id="weights" rows="4"
      placeholder="Comma or newline-separated numbers, e.g.:
12, 4, 9, 3, 7"></textarea>
    <div class="hint">If provided, N is ignored and the number of rectangles = number of weights.</div>

    <label>Label template (use {{name}}, {{index}}, {{percent}})</label>
    <textarea id="labelTpl" rows="2">{{name}}
    {{percent}}%</textarea>
    <fieldset>
      <legend>Color mode</legend>

      <div class="inline-radio">
        <input type="radio" name="colormode" value="random" id="mode-random" checked>
        <label for="mode-random">Random palette (default)</label>
      </div>

      <div class="inline-radio">
        <input type="radio" name="colormode" value="gradient" id="mode-gradient">
        <label for="mode-gradient">Sample from linear gradient style</label>
      </div>

      <div id="gradient-controls" style="display:none; margin-top:6px;">
        <label>Gradient style</label>
        <select id="gradientStyle">
          <option value="">(loading…)</option>
        </select>

        <fieldset style="margin-top:10px;">
          <legend>Create new gradient style</legend>
          <div class="row">
            <div>
              <label>Start color</label>
              <input id="gStart" type="text" value="#5F88FF" />
            </div>
            <div>
              <label>End color</label>
              <input id="gEnd" type="text" value="#00D0A0" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Angle (deg)</label>
              <input id="gAngle" type="number" value="0" />
            </div>
            <div>
              <label>Name</label>
              <input id="gName" type="text" value="Treemap Gradient" />
            </div>
          </div>
          <button id="createGradient">Create gradient style</button>
          <div class="hint">Creates a local linear gradient paint style you can reuse.</div>
          <div class="hint">Note: Only <b>local</b> paint styles appear here. Duplicate library styles into this file if needed.</div>
        </fieldset>
      </div>
    </fieldset>

    <button id="run">Fill selected frame</button>

    <script>
      const $ = (id) => document.getElementById(id);

      // Request styles from main
      function requestStyles() {
        parent.postMessage({ pluginMessage: { type: 'request-styles' } }, '*');
      }

      function getColorMode() {
        const el = document.querySelector('input[name="colormode"]:checked');
        return el ? el.value : 'random';
      }

      // Toggle gradient controls + re-fetch styles when needed
      function updateColorModeUI() {
        const isGradient = getColorMode() === 'gradient';
        $('gradient-controls').style.display = isGradient ? 'block' : 'none';
        if (isGradient) requestStyles();
      }
      document.querySelectorAll('input[name="colormode"]').forEach(r => {
        r.addEventListener('change', updateColorModeUI);
      });

      // Receive messages from code.js
      window.onmessage = (e) => {
        const msg = e.data.pluginMessage;
        if (!msg) return;

        if (msg.type === 'styles') {
          const sel = $('gradientStyle');
          sel.innerHTML = '';
          if (!msg.styles.length) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = '(no linear gradient styles found)';
            sel.appendChild(opt);
          } else {
            msg.styles.forEach(s => {
              const opt = document.createElement('option');
              opt.value = s.id;
              opt.textContent = s.name;
              sel.appendChild(opt);
            });
          }
        }

        if (msg.type === 'style-created') {
          const sel = $('gradientStyle');
          const opt = document.createElement('option');
          opt.value = msg.style.id;
          opt.textContent = msg.style.name;
          sel.appendChild(opt);
          sel.value = msg.style.id;
        }
      };

      // Initial load: request styles and ensure correct visibility
      window.addEventListener('DOMContentLoaded', () => {
        requestStyles();
        setTimeout(requestStyles, 100); // timing safety
        updateColorModeUI();
      });

      // Create gradient style
      $('createGradient').onclick = () => {
        const payload = {
          type: 'create-gradient-style',
          name: $('gName').value.trim() || 'Treemap Gradient',
          start: $('gStart').value.trim(),
          end: $('gEnd').value.trim(),
          angle: parseFloat($('gAngle').value) || 0
        };
        parent.postMessage({ pluginMessage: payload }, '*');
      };

      // Run treemap
      $('run').onclick = () => {
        const count = parseInt($('count').value, 10);
        const padding = parseFloat($('padding').value);
        const seed = $('seed').value.trim();

        let weightsRaw = $('weights').value.trim();
        let weights = null;
        if (weightsRaw.length) {
          weights = weightsRaw
            .split(/[\s,]+/)
            .map(Number)
            .filter(n => Number.isFinite(n) && n > 0);
          if (!weights.length) weights = null;
        }

        const colorMode = getColorMode();
        const gradientStyleId = colorMode === 'gradient' ? $('gradientStyle').value : '';

        parent.postMessage({
          pluginMessage: { type: 'run', count, padding, seed, weights, colorMode, gradientStyleId }
        }, '*');
      };
    </script>
  </body>
</html>